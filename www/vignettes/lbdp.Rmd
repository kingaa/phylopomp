---
title: "Linear birth-death model: Numerical tests"
author: "Aaron A. King"
output:
  html_document:
    code_folding: hide
    df_print: paged
    highlight: tango
    number_sections: no
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
      smooth_scroll: yes
params:
  prefix: "lbdp_test"
---

```{r include=FALSE,purl=FALSE,cache=FALSE}
library(knitr)
opts_chunk$set(
             progress=TRUE,
             prompt=FALSE,tidy=FALSE,highlight=TRUE,
             strip.white=TRUE,
             message=FALSE,
             warning=FALSE,
             error=TRUE,
             echo=TRUE,
             cache=TRUE,
             cache.extra=rand_seed,
             results='markup',
             fig.show='asis',
             size='small',
             fig.path=paste0("figure/",params$prefix,"-"),
             cache.path=paste0("cache/",params$prefix,"-"),
             fig.align='center',
             fig.height=4,fig.width=6.83,
             dpi=100,
             dev='png',
             dev.args=list(bg='transparent')
           )
options(
  keep.source=TRUE,
  encoding="UTF-8"
)
```

```{r pkgs,echo=FALSE,results="hide",message=FALSE,cache=FALSE}
library(phylopomp)
library(tidyverse)
set.seed(407643109L)
```

## Verifying the attachment distribution

We investigate the distributions of the cumulative hazards of the conditional attachment process.
These should be perfectly distributed according to the standard exponential distribution.

```{r hazards,echo=TRUE,cache=TRUE}
library(doParallel)
library(doRNG)
registerDoParallel()
registerDoRNG(438522210)

expand_grid(
  lambda=1,
  mu=c(0.5,1,2),
  psi=c(0.5,1,2),
  n0=c(1,10,100),
  rep=1:50
) %>%
  group_by(rep) %>%
  mutate(
    case=seq_len(n()),
    tf=if_else(
      lambda != mu,
      log(1+100/n0*(lambda-mu)/psi)/(lambda-mu),
      100/n0/psi
    )
  ) %>%
  ungroup() %>%
  mutate(tf=if_else(tf>3,3,tf)) %>%
  arrange(rep,case) -> pars

foreach (par=iter(pars,"row"),.inorder=FALSE) %dopar%
  {
    library(phylopomp)
    library(tidyverse)
    par %$%
      playLBDP(
        lambda=lambda,mu=mu,psi=psi,
        n0=n0,t0=0,times=tf,
        tree=FALSE
      ) %>%
      getInfo(tree=FALSE) -> x
    bind_cols(par,x$cumhaz)
  } %>%
  bind_rows() %>%
  filter(!is.na(Lambda)) %>%
  mutate(p=exp(-Lambda)) %>%
  arrange(case,rep,time) -> dat
```

We use Kolmogorov-Smirnov to test the hypothesis that the cumulative hazards are distributed as expected.

```{r ks_tests,echo=TRUE,fig.width=8,fig.height=8,purl=FALSE}
library(broom)

dat %>%
  group_by(n0) %>%
  summarize(n=n(),tidy(ks.test(x=p,y=punif))) %>%
  select(n0,n,p.value)

dat %>%
  mutate(n0=factor(n0)) %>%
  ggplot(aes(x=p,group=n0,color=n0))+
  geom_abline(slope=1)+
  stat_ecdf()+
  coord_equal()+
  labs(
    color=expression(N[0]),
    x=expression(italic(p)),
    y=expression(italic(F(p)))
  )+
  expand_limits(x=c(0,1),y=c(0,1))

dat %>%
  group_by(nsamp=psi/mu) %>%
  summarize(n=n(),tidy(ks.test(x=p,y=punif))) %>%
  select(nsamp,n,p.value)

dat %>%
  mutate(nsamp=factor(psi/mu)) %>%
  ggplot(aes(x=p,group=nsamp,color=nsamp))+
  geom_abline(slope=1)+
  stat_ecdf()+
  coord_equal()+
  labs(
    color=expression(psi/mu),
    x=expression(italic(p)),
    y=expression(italic(F(p)))
  )+
  expand_limits(x=c(0,1),y=c(0,1))

dat %>%
  group_by(n0,R0=lambda/mu) %>%
  summarize(n=n(),tidy(ks.test(x=p,y=punif))) %>%
  select(R0,n0,n,p.value)

dat %>%
  mutate(R0=factor(lambda/mu)) %>%
  ggplot(aes(x=p))+
  geom_abline(slope=1)+
  stat_ecdf()+
  coord_equal()+
  labs(
    color=expression(R[0]==beta/gamma),
    x=expression(italic(p)),
    y=expression(italic(F(p)))
  )+
  expand_limits(x=c(0,1),y=c(0,1))+
  facet_grid(R0~n0)

dat %>%
  summarize(n=n(),tidy(ks.test(x=p,y=punif))) %>%
  select(n,p.value)

dat %>%
  group_by(case) %>%
  summarize(n=n(),tidy(ks.test(x=p,y=punif))) %>%
  select(case,n,p.value) -> pvals

pvals %>%
  summarize(n=n(),tidy(ks.test(x=p.value,y=punif))) %>%
  select(n,p.value) -> ppval

dat %>%
  ggplot(aes(x=p))+
  geom_abline(slope=1)+
  stat_ecdf()+
  annotate("rug",x=pvals$p.value)+
  annotate("text",x=0.2,y=0.8,
           label=sprintf("P==%3.2f",ppval$p.value),parse=TRUE)+
  coord_equal()+
  labs(x=expression(italic(p)),y=expression(italic(F(p))))+
  expand_limits(x=c(0,1),y=c(0,1))
```

## Session Info

```{r session_info,echo=FALSE}
sessionInfo()
```

## References
